{% extends "base.html" %}
{% block content %}
    <div class="container mt-5">
        <h2 class="text-center text-muted fw-semibold mb-4" style="font-size: 2rem; letter-spacing: 0.5px; text-transform: capitalize;">
            Create your account
        </h2>

        {% if messages %}
        {% for message in messages %}
            <div class="alert alert-danger" role="alert">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}

        <form method="post" class="border p-4 shadow rounded w-50 mx-auto mt-5 mb-5" id="registerForm">
            {% csrf_token %}
            <div class="mb-3">
                <label for="{{ form.first_name.id_for_label }}" class="form-label">{{ form.first_name.label }}</label>
                {{ form.first_name }}
                {% if form.first_name.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.first_name.errors }}
                </div>
                {% endif %}
            </div>
            <div class="mb-3">
                <label for="{{ form.last_name.id_for_label }}" class="form-label">{{ form.last_name.label }}</label>
                {{ form.last_name }}
                {% if form.last_name.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.last_name.errors }}
                </div>
                {% endif %}
            </div>
            <div class="mb-3">
                <label for="{{ form.email.id_for_label }}" class="form-label">{{ form.email.label }}</label>
                {{ form.email }}
                {% if form.email.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.email.errors }}
                </div>
                {% endif %}
            </div>
            <div class="mb-3">
                <label for="{{ form.password.id_for_label }}" class="form-label">{{ form.password.label }}</label>
                {{ form.password }}
                {% if form.password.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.password.errors }}
                </div>
                {% endif %}
            </div>
            <div class="mb-3">
                <label for="{{ form.repeated_password.id_for_label }}" class="form-label">{{ form.repeated_password.label }}</label>
                {{ form.repeated_password }}
                {% if form.repeated_password.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.repeated_password.errors }}
                </div>
                {% endif %}
            </div>
            <div class="mb-3">
                <label for="{{ form.mobile.id_for_label }}" class="form-label">{{ form.mobile.label }}</label>
                {{ form.mobile }}
                {% if form.mobile.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.mobile.errors }}
                </div>
                {% endif %}
                <div class="invalid-feedback" id="mobileError">
                    Please enter a valid phone number in format: xxx xxx xxx
                </div>
            </div>
            <div class="mb-3">
                <label for="{{ form.country.id_for_label }}" class="form-label">{{ form.country.label }}</label>
                {{ form.country }}
                {% if form.country.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.country.errors }}
                </div>
                {% endif %}
            </div>
            <div class="mb-3">
                <label for="{{ form.city.id_for_label }}" class="form-label">{{ form.city.label }}</label>
                {{ form.city }}
                {% if form.city.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.city.errors }}
                </div>
                {% endif %}
            </div>
            <div class="mb-3">
                <label for="{{ form.role.id_for_label }}" class="form-label">{{ form.role.label }}</label>
                {{ form.role }}
                {% if form.role.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.role.errors }}
                </div>
                {% endif %}
            </div>
            <div class="mb-3 worker-fields" style="display: none;">
                <label for="{{ form.position.id_for_label }}" class="form-label">{{ form.position.label }}</label>
                {{ form.position }}
                {% if form.position.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.position.errors }}
                </div>
                {% endif %}
            </div>
            <div class="mb-3 worker-fields" style="display: none;">
                <label for="{{ form.starts_in.id_for_label }}" class="form-label">{{ form.starts_in.label }}</label>
                {{ form.starts_in }}
                {% if form.starts_in.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.starts_in.errors }}
                </div>
                {% endif %}
            </div>
            <div class="mb-3 worker-fields" style="display: none;">
                <label class="form-label">Optional Work Models</label>
                <div class="form-check">
                    {{ form.is_remote }}
                    <label class="form-check-label" for="{{ form.is_remote.id_for_label }}">{{ form.is_remote.label }}</label>
                </div>
                <div class="form-check">
                    {{ form.is_hybrid }}
                    <label class="form-check-label" for="{{ form.is_hybrid.id_for_label }}">{{ form.is_hybrid.label }}</label>
                </div>
            </div>
            <button type="button" name="register" class="btn btn-secondary" onclick="window.location.href='/login'">Login</button>
            <button type="submit" name="register" class="btn btn-primary me-2">Register</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mobileInput = document.querySelector('input[name="mobile"]');
            const mobileError = document.getElementById('mobileError');
            const form = document.getElementById('registerForm');
            const roleSelect = document.querySelector('select[name="role"]');
            const workerFields = document.querySelectorAll('.worker-fields');
            const positionInput = document.querySelector('input[name="position"]');
            const startsInSelect = document.querySelector('select[name="starts_in"]');
            const countrySelect = document.querySelector('select[name="country"]');
            const citySelect = document.querySelector('select[name="city"]');

            // Location data
            const locations = {
                'Poland': ['Warsaw', 'Krakow', 'Wroclaw', 'Poznan', 'Gdansk', 'Lodz', 'Katowice', 'Lublin', 'Bialystok', 'Szczecin'],
                'Germany': ['Berlin', 'Munich', 'Hamburg', 'Frankfurt', 'Cologne', 'Stuttgart', 'Dusseldorf', 'Leipzig', 'Dortmund', 'Essen'],
                'United Kingdom': ['London', 'Manchester', 'Birmingham', 'Leeds', 'Glasgow', 'Liverpool', 'Newcastle', 'Sheffield', 'Bristol', 'Edinburgh'],
                'France': ['Paris', 'Marseille', 'Lyon', 'Toulouse', 'Nice', 'Nantes', 'Strasbourg', 'Montpellier', 'Bordeaux', 'Lille'],
                'Spain': ['Madrid', 'Barcelona', 'Valencia', 'Seville', 'Zaragoza', 'Malaga', 'Murcia', 'Palma', 'Las Palmas', 'Bilbao'],
                'Italy': ['Rome', 'Milan', 'Naples', 'Turin', 'Palermo', 'Genoa', 'Bologna', 'Florence', 'Bari', 'Catania'],
                'Netherlands': ['Amsterdam', 'Rotterdam', 'The Hague', 'Utrecht', 'Eindhoven', 'Tilburg', 'Groningen', 'Almere', 'Breda', 'Nijmegen'],
                'Sweden': ['Stockholm', 'Gothenburg', 'Malmo', 'Uppsala', 'Vasteras', 'Orebro', 'Linkoping', 'Helsingborg', 'Jonkoping', 'Norrkoping'],
                'Norway': ['Oslo', 'Bergen', 'Stavanger', 'Trondheim', 'Drammen', 'Fredrikstad', 'Kristiansand', 'Sandnes', 'Tromso', 'Sarpsborg'],
                'Switzerland': ['Zurich', 'Geneva', 'Basel', 'Bern', 'Lausanne', 'Winterthur', 'Lucerne', 'St. Gallen', 'Lugano', 'Biel/Bienne'],
                'Austria': ['Vienna', 'Graz', 'Linz', 'Salzburg', 'Innsbruck', 'Klagenfurt', 'Villach', 'Wels', 'Sankt Polten', 'Dornbirn'],
                'Czech Republic': ['Prague', 'Brno', 'Ostrava', 'Plzen', 'Liberec', 'Olomouc', 'Usti nad Labem', 'Hradec Kralove', 'Pardubice', 'Zlin'],
                'USA': ['New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix', 'Philadelphia', 'San Antonio', 'San Diego', 'Dallas', 'San Jose'],
                'Ireland': ['Dublin', 'Cork', 'Galway', 'Limerick', 'Waterford'],
                'Finland': ['Helsinki', 'Espoo', 'Tampere', 'Vantaa', 'Oulu'],
                'Denmark': ['Copenhagen', 'Aarhus', 'Odense', 'Aalborg', 'Esbjerg'],
                'Portugal': ['Lisbon', 'Porto', 'Braga', 'Coimbra', 'Aveiro'],
                'Belgium': ['Brussels', 'Antwerp', 'Ghent', 'Charleroi', 'Liege'],
                'Romania': ['Bucharest', 'Cluj-Napoca', 'Timisoara', 'Iasi', 'Brasov'],
                'Hungary': ['Budapest', 'Debrecen', 'Szeged', 'Miskolc', 'Pecs'],
                'Estonia': ['Tallinn', 'Tartu', 'Narva', 'Parnu', 'Viljandi'],
                'Lithuania': ['Vilnius', 'Kaunas', 'Klaipeda', 'Å iauliai', 'Panevezys'],
                'Latvia': ['Riga', 'Daugavpils', 'Liepaja', 'Jelgava', 'Jurmala'],
                'Ukraine': ['Kyiv', 'Lviv', 'Kharkiv', 'Dnipro', 'Odesa'],
                'Bulgaria': ['Sofia', 'Plovdiv', 'Varna', 'Burgas', 'Ruse'],
                'Greece': ['Athens', 'Thessaloniki', 'Patras', 'Heraklion', 'Larissa'],
                'Turkey': ['Istanbul', 'Ankara', 'Izmir', 'Bursa', 'Antalya']
            };

            // Update cities based on selected country
            function updateCities() {
                const selectedCountry = countrySelect.value;
                citySelect.innerHTML = '<option value="">---</option>';
                
                if (selectedCountry && locations[selectedCountry]) {
                    locations[selectedCountry].forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        citySelect.appendChild(option);
                    });
                }
            }

            // Initial update of cities
            updateCities();

            countrySelect.addEventListener('change', updateCities);

            function toggleWorkerFields() {
                const isWorker = roleSelect.value === 'worker';
                workerFields.forEach(field => {
                    field.style.display = isWorker ? 'block' : 'none';
                });
                if (isWorker) {
                    positionInput.setAttribute('required', 'required');
                    startsInSelect.setAttribute('required', 'required');
                } else {
                    positionInput.removeAttribute('required');
                    startsInSelect.removeAttribute('required');
                }
            }

            toggleWorkerFields();
            roleSelect.addEventListener('change', toggleWorkerFields);

            function formatPhoneNumber(input) {
                let value = input.value.replace(/\D/g, '');
                if (value.length > 9) value = value.slice(0, 9);
                if (value.length > 6) {
                    value = value.slice(0, 6) + ' ' + value.slice(6);
                }
                if (value.length > 3) {
                    value = value.slice(0, 3) + ' ' + value.slice(3);
                }
                input.value = value;
            }

            function validatePhoneNumber(value) {
                return /^\d{3} \d{3} \d{3}$/.test(value);
            }

            mobileInput.addEventListener('input', function() {
                formatPhoneNumber(this);
                if (this.value && !validatePhoneNumber(this.value)) {
                    this.classList.add('is-invalid');
                    mobileError.style.display = 'block';
                } else {
                    this.classList.remove('is-invalid');
                    mobileError.style.display = 'none';
                }
            });

            form.addEventListener('submit', function(e) {
                if (mobileInput.value && !validatePhoneNumber(mobileInput.value)) {
                    e.preventDefault();
                    mobileInput.classList.add('is-invalid');
                    mobileError.style.display = 'block';
                }

                // Validate city selection
                const selectedCountry = countrySelect.value;
                const selectedCity = citySelect.value;
                if (selectedCountry && selectedCity) {
                    if (!locations[selectedCountry] || !locations[selectedCountry].includes(selectedCity)) {
                        e.preventDefault();
                        citySelect.classList.add('is-invalid');
                    } else {
                        citySelect.classList.remove('is-invalid');
                    }
                }
            });
        });
    </script>
{% endblock %}
